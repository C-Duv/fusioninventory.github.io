# SNMP description model

The SNMP description model is a data structure of exhaustive model-specific
informations, intended to be used during remote inventory phase of a device.

They are stored as multiple XML file on the GLPI server (under
gpli_plugins_directory/fusinvsnmp/models), imported into GLPI database at
installation, and transmitted to the agent when needed as part of the inventory
request.

## Format

Here is a simple DTD:

    <!ELEMENT model (name,type,key,comments,devices,oidlist)>
    <!ELEMENT name (#PCDATA)>
    <!ELEMENT type (2|3)>
    <!ELEMENT key (#PCDATA)>
    <!ELEMENT comments (#PCDATA)>
    <!ELEMENT devices (sysdescr*)>
    <!ELEMENT sysdescr (#PCDATA)>
    <!ELEMENT oidlist (oidobject*)>
    <!ELEMENT oidobject (object,oid,portcounter,dynamicport,mapping_type,mapping_name,vlan,activation>
    <!ELEMENT object (#PCDATA)>
    <!ELEMENT oid (#PCDATA)>
    <!ELEMENT portcounter (0|1)>
    <!ELEMENT dynamicport (0|1)>
    <!ELEMENT mapping_type (#PCDATA)>
    <!ELEMENT mapping_name (#PCDATA)>
    <!ELEMENT vlan (0|1)>
    <!ELEMENT activation (0|1)>

Here are the description for the various elements:

* name: SNMP model name
* key: SNMP model key
* comments: raw list of sysdescr values of compatible devices, newline-separated
* devices:  structured list of sysdescr values of compatible devices,
  in array
* oidlist: list of oidobject element
* mapping_name: the actual name of the mapped variable
* oid: the oid of the mapped variable
* dynamicport: wether this is a single-valued or a multivalued variable
* object: unused
* portcounter: Define if this oid is THE port counter (list number of ports)
* vlan: wether this is a vlan-specific variable
* activation: Be able to active or disable this oid in GLPI (so not required in snmp model)

Problems:

* the model name is redundant with the model key, and less informative
* usage of a numeric value for the type is barely human-readable
* comments is redundant with devices, and less structured (comments is not deleted to be compatible with old version of plugin in GLPI, since 0.83+2.x version we use devices node)
* defining vlan-sensitivity for each property is useless, as it always cover
  the same properties set (dot*), and could be made global instead
* defining mapping type for each property does not make sense: the whole model
  is either a printer or a network model
* portcounter information isn't used by the agent, and could be replaced by a
  global element
* dynamicport information isn't used by the agent, as each properties is always
  single or multi-valued

## Properties

Problems:

* model and entPhysicalModelName properties are redundant, as they are used to
define device model, but in different context (network and printers). They
should be merged as a generic property.
* no explicit difference between ram and memory properties

### Generic properties

They are used for all kind of devices:

* comments
* contact
* cpu
* enterprise
* firmware1
* firmware2
* firmware
* ifaddr
* ifdescr
* ifIndex
* ifinerrors
* ifinoctets
* ifinternalstatus
* iflastchange
* ifmtu
* ifName
* ifouterrors
* ifoutoctets
* ifPhysAddress
* ifspeed
* ifstatus
* ifType
* location
* macaddr
* memory
* name
* otherserial
* ram
* serial
* uptime

### Printer properties

They are used for printer devices only:

* cartridgeblack
* cartridgecyanlight
* cartridgecyan
* cartridgemagentalight
* cartridgemagenta
* cartridgeyellow
* drumblack
* drumblackmax
* drumblackremaining
* drumcyan
* drumcyanmax
* drumcyanremaining
* drummagenta
* drumyellow
* maintenancekit
* maintenancekitmax
* maintenancekitremaining
* model
* pagecounterblackpages_copy
* pagecounterblackpages
* pagecounterblackpages_print
* pagecountercolorpages_copy
* pagecountercolorpages
* pagecountercolorpages_print
* pagecounterrectoversopages
* pagecounterscannedpages
* pagecountertotalpages_copy
* pagecountertotalpages_fax
* pagecountertotalpages
* pagecountertotalpages_print
* tonerblack2
* tonerblack2max
* tonerblack2remaining
* tonerblack
* tonerblackmax
* tonerblackremaining
* tonercyan
* tonercyanmax
* tonercyanremaining
* tonermagenta
* tonermagentamax
* tonermagentaremaining
* toneryellow
* toneryellowmax
* toneryellowremaining
* wastetoner
* wastetonermax
* wastetonerremaining

### Network properties

They are used for network devices only:

* cdpCacheAddress
* cdpCacheDeviceId
* cdpCacheDevicePort
* cdpCachePlatform
* cdpCacheVersion
* dot1dBasePortIfIndex
* dot1dTpFdbAddress
* dot1dTpFdbPort
* entPhysicalModelName
* ipAdEntAddr
* lldpLocChassisId
* lldpRemChassisId
* lldpRemPortDesc
* lldpRemPortId
* lldpRemSysDesc
* lldpRemSysName
* PortVlanIndex: only used for Nortel hardware
* vmvlan
* vtpVlanName
* vlanTrunkPortDynamicStatus

### Unused properties

* ifAlias
* informations
* ipNetToMediaPhysAddress

## Communication

The server send a copy of each needed SNMP models to the agent, as part of its
inventory request. Here is a sample of such message:

    <MODEL ID="196" NAME="4675719">
        <GET OBJECT="name" OID=".1.3.6.1.2.1.1.5.0" VLAN="0" LINK="name"/>
        <WALK OBJECT="ifIndex" OID=".1.3.6.1.2.1.2.2.1.1" VLAN="0" LINK="ifIndex"/>
        <WALK OBJECT="ifaddr" OID=".1.3.6.1.2.1.4.20.1.2" VLAN="0" LINK="ifaddr"/>
        <GET OBJECT="informations" OID=".1.3.6.1.4.1.11.2.3.9.1.1.7.0" VLAN="0" LINK="informations"/>
    </MODEL>

Problems:

* the data structure doesn't match the one used for storing model
* LINK attribute isn't used
* the server doesn't allow dictionnary retrieval outside of a scheduled
  inventory task, making usage of alternative tools difficult
  ([issue 1993](http://forge.fusioninventory.org/issues/1993))

## Local customisation

Each model is stored as an XML file, distributed with Fusioninventory plugin
for GLPI, in glpi/plugins/fusioninventory/snmpmodels directory. At plugin
installation, those models are imported into GLPI database, and XML files are
subsequently ignored. Models can be modified either by modificating the XML
files, and reimporting them, or directly in the database through GLPI
interface.

At plugin update, existing XML files are replaced by new ones included in the
plugin, the GLPI database models are deleted, and all content of the
glpi/plugins/fusioninventory/snmpmodels is imported again. As a consequence,
in order to make local modification persistent, they have to be saved in XML
files, using filenames different from the ones included in the plugin.

## Enhancement proposals

### Proposal 1

Drop the confusing distinction between a model name and a model key, and use a
single model identifier everywhere:

* as model xml file name
* in model data
* in GLPI interface

### Proposal 2

Drop useless informations from the model. Here is an alternate DTD:

    <!ELEMENT model (type,key,portCounter,vlanInfo,devices,properties)>
    <!ELEMENT type (NETWORKING|PRINTER)>
    <!ELEMENT key (#PCDATA)>
    <!ELEMENT portCounter (#PCDATA)>
    <!ELEMENT vlanInfo (#PCDATA)>
    <!ELEMENT devices (sysdescr*)>
    <!ELEMENT sysdescr (#PCDATA)>
    <!ELEMENT properties (property*)>
    <!ELEMENT property (name,oid,activation)*>
    <!ELEMENT name (#PCDATA)>
    <!ELEMENT oid (#PCDATA)>
    <!ELEMENT activation (0|1)>

And a sample instance:

    <model>
        <key>Printer0547</key>
        <type>PRINTER</type>
        <portCounter></portCounter>
        <vlanInfo>0</vlanInfo>
        ...
        <properties>
            <property>
                <name>comments</name>
                <oid>.1.3.6.1.2.1.1.1.0</oid>
                <activation>1</activation>
            </property>
        ...
            <property>
                <name>ifaddr</name>
                <oid>.1.3.6.1.2.1.4.20.1.2</oid>
                <activation>1</activation>
            </property>
        </properties>
    </model>

### Proposal 3

Drop default values from models, hardcode them in the agent, and use models to
push exceptions only.
